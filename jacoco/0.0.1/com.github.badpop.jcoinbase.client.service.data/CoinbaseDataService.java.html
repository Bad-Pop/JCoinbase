<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CoinbaseDataService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JCoinbase</a> &gt; <a href="index.source.html" class="el_package">com.github.badpop.jcoinbase.client.service.data</a> &gt; <span class="el_source">CoinbaseDataService.java</span></div><h1>CoinbaseDataService.java</h1><pre class="source lang-java linenums">package com.github.badpop.jcoinbase.client.service.data;

import com.fasterxml.jackson.core.type.TypeReference;
import com.github.badpop.jcoinbase.client.JCoinbaseClient;
import com.github.badpop.jcoinbase.client.JCoinbaseProperties;
import com.github.badpop.jcoinbase.client.service.WarningManagerService;
import com.github.badpop.jcoinbase.client.service.data.dto.CurrencyDto;
import com.github.badpop.jcoinbase.client.service.data.dto.ExchangeRatesDto;
import com.github.badpop.jcoinbase.client.service.data.dto.PriceDto;
import com.github.badpop.jcoinbase.client.service.data.dto.TimeDto;
import com.github.badpop.jcoinbase.client.service.dto.DataDto;
import com.github.badpop.jcoinbase.control.CallResult;
import com.github.badpop.jcoinbase.model.CoinbaseError;
import com.github.badpop.jcoinbase.model.data.Currency;
import com.github.badpop.jcoinbase.model.data.ExchangeRates;
import com.github.badpop.jcoinbase.model.data.Price;
import com.github.badpop.jcoinbase.model.data.Price.PriceType;
import com.github.badpop.jcoinbase.model.data.Time;
import io.vavr.collection.List;
import io.vavr.collection.Seq;
import io.vavr.control.Try;
import lombok.val;

import java.net.URI;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;

import static com.github.badpop.jcoinbase.client.service.Headers.ACCEPT;
import static com.github.badpop.jcoinbase.client.service.Headers.ACCEPT_VALUE;
import static com.github.badpop.jcoinbase.client.service.JsonDeserializationService.singleFailureDeserialize;

<span class="fc" id="L32">public class CoinbaseDataService {</span>

  protected Try&lt;CallResult&lt;Seq&lt;CoinbaseError&gt;, Time&gt;&gt; fetchTime(final JCoinbaseClient client) {
    val request =
<span class="fc" id="L36">        HttpRequest.newBuilder()</span>
<span class="fc" id="L37">            .GET()</span>
<span class="fc" id="L38">            .uri(</span>
<span class="fc" id="L39">                URI.create(</span>
<span class="fc" id="L40">                    client.getProperties().getApiUrl() + client.getProperties().getTimePath()))</span>
<span class="fc" id="L41">            .header(ACCEPT.getValue(), ACCEPT_VALUE.getValue())</span>
<span class="fc" id="L42">            .build();</span>

<span class="fc" id="L44">    return Try.of(() -&gt; client.getHttpClient().send(request, HttpResponse.BodyHandlers.ofString()))</span>
<span class="fc" id="L45">        .mapTry(</span>
            response -&gt;
<span class="fc" id="L47">                singleFailureDeserialize(</span>
<span class="fc" id="L48">                    response, client.getJsonSerDes(), new TypeReference&lt;DataDto&lt;TimeDto&gt;&gt;() {}))</span>
<span class="fc" id="L49">        .mapTry(</span>
            callResult -&gt;
<span class="fc" id="L51">                callResult</span>
<span class="fc" id="L52">                    .peek(WarningManagerService::alertIfCoinbaseHasReturnedWarnings)</span>
<span class="fc" id="L53">                    .map(data -&gt; data.getData().toTime()));</span>
  }

  protected Try&lt;CallResult&lt;Seq&lt;CoinbaseError&gt;, Seq&lt;Currency&gt;&gt;&gt; fetchCurrencies(
      final JCoinbaseClient client) {

    val request =
<span class="fc" id="L60">        HttpRequest.newBuilder()</span>
<span class="fc" id="L61">            .GET()</span>
<span class="fc" id="L62">            .uri(</span>
<span class="fc" id="L63">                URI.create(</span>
<span class="fc" id="L64">                    client.getProperties().getApiUrl()</span>
<span class="fc" id="L65">                        + client.getProperties().getCurrenciesPath()))</span>
<span class="fc" id="L66">            .header(ACCEPT.getValue(), ACCEPT_VALUE.getValue())</span>
<span class="fc" id="L67">            .build();</span>

<span class="fc" id="L69">    return Try.of(() -&gt; client.getHttpClient().send(request, HttpResponse.BodyHandlers.ofString()))</span>
<span class="fc" id="L70">        .mapTry(</span>
            response -&gt;
<span class="fc" id="L72">                singleFailureDeserialize(</span>
                    response,
<span class="fc" id="L74">                    client.getJsonSerDes(),</span>
<span class="fc" id="L75">                    new TypeReference&lt;DataDto&lt;List&lt;CurrencyDto&gt;&gt;&gt;() {}))</span>
<span class="fc" id="L76">        .mapTry(</span>
            callResult -&gt;
<span class="fc" id="L78">                callResult</span>
<span class="fc" id="L79">                    .peek(WarningManagerService::alertIfCoinbaseHasReturnedWarnings)</span>
<span class="fc" id="L80">                    .map(DataDto::getData)</span>
<span class="fc" id="L81">                    .map(currencies -&gt; currencies.map(CurrencyDto::toCurrency)));</span>
  }

  protected Try&lt;CallResult&lt;Seq&lt;CoinbaseError&gt;, ExchangeRates&gt;&gt; fetchExchangeRates(
      final JCoinbaseClient client, final String currency) {

    val request =
<span class="fc" id="L88">        HttpRequest.newBuilder()</span>
<span class="fc" id="L89">            .GET()</span>
<span class="fc" id="L90">            .uri(</span>
<span class="fc" id="L91">                URI.create(</span>
<span class="fc" id="L92">                    client.getProperties().getApiUrl()</span>
<span class="fc" id="L93">                        + client.getProperties().getExchangeRatesPath()</span>
                        + currency))
<span class="fc" id="L95">            .header(ACCEPT.getValue(), ACCEPT_VALUE.getValue())</span>
<span class="fc" id="L96">            .build();</span>

<span class="fc" id="L98">    return Try.of(() -&gt; client.getHttpClient().send(request, HttpResponse.BodyHandlers.ofString()))</span>
<span class="fc" id="L99">        .mapTry(</span>
            response -&gt;
<span class="fc" id="L101">                singleFailureDeserialize(</span>
                    response,
<span class="fc" id="L103">                    client.getJsonSerDes(),</span>
<span class="fc" id="L104">                    new TypeReference&lt;DataDto&lt;ExchangeRatesDto&gt;&gt;() {}))</span>
<span class="fc" id="L105">        .mapTry(</span>
            callResult -&gt;
<span class="fc" id="L107">                callResult</span>
<span class="fc" id="L108">                    .peek(WarningManagerService::alertIfCoinbaseHasReturnedWarnings)</span>
<span class="fc" id="L109">                    .map(DataDto::getData)</span>
<span class="fc" id="L110">                    .map(ExchangeRatesDto::toExchangeRates));</span>
  }

  protected Try&lt;CallResult&lt;Seq&lt;CoinbaseError&gt;, Price&gt;&gt; fetchPriceByType(
      JCoinbaseClient client, PriceType priceType, String baseCurrency, String targetCurrency) {

    val request =
<span class="fc" id="L117">        HttpRequest.newBuilder()</span>
<span class="fc" id="L118">            .GET()</span>
<span class="fc" id="L119">            .uri(buildPriceURI(client.getProperties(), priceType, baseCurrency, targetCurrency))</span>
<span class="fc" id="L120">            .header(ACCEPT.getValue(), ACCEPT_VALUE.getValue())</span>
<span class="fc" id="L121">            .build();</span>

<span class="fc" id="L123">    return Try.of(() -&gt; client.getHttpClient().send(request, HttpResponse.BodyHandlers.ofString()))</span>
<span class="fc" id="L124">        .mapTry(</span>
            response -&gt;
<span class="fc" id="L126">                singleFailureDeserialize(</span>
<span class="fc" id="L127">                    response, client.getJsonSerDes(), new TypeReference&lt;DataDto&lt;PriceDto&gt;&gt;() {}))</span>
<span class="fc" id="L128">        .mapTry(</span>
            callResult -&gt;
<span class="fc" id="L130">                callResult</span>
<span class="fc" id="L131">                    .peek(WarningManagerService::alertIfCoinbaseHasReturnedWarnings)</span>
<span class="fc" id="L132">                    .map(DataDto::getData)</span>
<span class="fc" id="L133">                    .map(price -&gt; price.toPrice(priceType)));</span>
  }

  // TODO : CHECK IF COINBASE GIVE ENDPOINT FOR SUPPORTED CURRENCIES PAIRS AND USE IT INSTEAD
  private URI buildPriceURI(
      final JCoinbaseProperties properties,
      final PriceType priceType,
      final String baseCurrency,
      final String targetCurrency) {
<span class="fc" id="L142">    return URI.create(</span>
<span class="fc" id="L143">        String.format(</span>
            &quot;%s%s/%s/%s&quot;,
<span class="fc" id="L145">            properties.getApiUrl(),</span>
<span class="fc" id="L146">            properties.getPricesPath(),</span>
            baseCurrency + &quot;-&quot; + targetCurrency,
<span class="fc" id="L148">            priceType.getType()));</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>