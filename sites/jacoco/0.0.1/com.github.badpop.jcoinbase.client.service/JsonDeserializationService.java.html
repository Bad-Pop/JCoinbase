<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JsonDeserializationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JCoinbase</a> &gt; <a href="index.source.html" class="el_package">com.github.badpop.jcoinbase.client.service</a> &gt; <span class="el_source">JsonDeserializationService.java</span></div><h1>JsonDeserializationService.java</h1><pre class="source lang-java linenums">package com.github.badpop.jcoinbase.client.service;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.github.badpop.jcoinbase.client.service.dto.DataDto;
import com.github.badpop.jcoinbase.client.service.dto.DataErrorDto;
import com.github.badpop.jcoinbase.client.service.dto.DataErrorsDto;
import com.github.badpop.jcoinbase.client.service.dto.SingleErrorDto;
import com.github.badpop.jcoinbase.control.CallResult;
import com.github.badpop.jcoinbase.model.CoinbaseError;
import io.vavr.collection.Seq;

import java.net.http.HttpResponse;

import static io.vavr.API.Seq;

/**
 * Utility interface that allow us to deserialize coinbase api responses from json to java objects
 */
public interface JsonDeserializationService {

  /**
   * Generic method to centralized the deserialization process of coinbase api responses and wrap
   * the results in a {@link CallResult} object
   *
   * &lt;p&gt;This method is different of {@link #singleFailureDeserialize(HttpResponse, ObjectMapper,
   * TypeReference)} and should be used for all Coinbase api responses except for public data.
   * Public data does not return errors in the same way as protected data.
   *
   * @param response the http response
   * @param jsonSerDes the jackson object mapper to use
   * @param typeReference the jackson type reference for deserialization
   * @param &lt;T&gt; the object type to deserialize
   * @return a new {@link CallResult} representing a success or a failure
   * @throws JsonProcessingException if not deserializable
   */
  static &lt;T&gt; CallResult&lt;Seq&lt;CoinbaseError&gt;, DataDto&lt;T&gt;&gt; deserialize(
      final HttpResponse&lt;String&gt; response,
      final ObjectMapper jsonSerDes,
      final TypeReference&lt;DataDto&lt;T&gt;&gt; typeReference)
      throws JsonProcessingException {
<span class="fc bfc" id="L43" title="All 2 branches covered.">    if (isOk(response.statusCode())) {</span>
<span class="fc" id="L44">      return buildSuccess(response, jsonSerDes, typeReference);</span>
    } else {
<span class="fc" id="L46">      return buildFailure(response, jsonSerDes);</span>
    }
  }

  /**
   * Generic method to centralized the deserialization process of coinbase api responses and wrap
   * the results in a {@link CallResult} object
   *
   * &lt;p&gt;This method is different of {@link #deserialize(HttpResponse, ObjectMapper, TypeReference)}
   * and should be used only for public data. Protected data does not return errors in the same way
   * as public data.
   *
   * @param response the http response
   * @param jsonSerDes the jackson object mapper to use
   * @param typeReference the jackson type reference for deserialization
   * @param &lt;T&gt; the object type to deserialize
   * @return a new {@link CallResult} representing a success or a failure
   * @throws JsonProcessingException if not deserializable
   */
  // TODO REFACTOR TO HAVE ONLY ONE DESERIALIZATION METHOD ?
  static &lt;T&gt; CallResult&lt;Seq&lt;CoinbaseError&gt;, DataDto&lt;T&gt;&gt; singleFailureDeserialize(
      final HttpResponse&lt;String&gt; response,
      final ObjectMapper jsonSerDes,
      final TypeReference&lt;DataDto&lt;T&gt;&gt; typeReference)
      throws JsonProcessingException {
<span class="fc bfc" id="L71" title="All 2 branches covered.">    if (isOk(response.statusCode())) {</span>
<span class="fc" id="L72">      return buildSuccess(response, jsonSerDes, typeReference);</span>
    } else {
<span class="fc" id="L74">      return buildSingleFailure(response, jsonSerDes);</span>
    }
  }

  /**
   * A simple method to check if a response status is between 200 and 204
   *
   * @param statusCode the http response status code
   * @return true if between 200 and 204, false otherwise
   */
  private static boolean isOk(final int statusCode) {
<span class="pc bpc" id="L85" title="1 of 4 branches missed.">    return statusCode &gt;= 200 &amp;&amp; statusCode &lt;= 204;</span>
  }

  /**
   * Create a new {@link com.github.badpop.jcoinbase.control.CallResult.Success} containing the
   * result
   *
   * @param response the http response
   * @param jsonSerDes the jackson object mapper to use
   * @param typeReference the jackson type reference for deserialization
   * @param &lt;T&gt; the object type to deserialize
   * @return a new {@link CallResult} representing a success
   * @throws JsonProcessingException if not deserializable
   */
  private static &lt;T&gt; CallResult&lt;Seq&lt;CoinbaseError&gt;, DataDto&lt;T&gt;&gt; buildSuccess(
      final HttpResponse&lt;String&gt; response,
      final ObjectMapper jsonSerDes,
      final TypeReference&lt;DataDto&lt;T&gt;&gt; typeReference)
      throws JsonProcessingException {
<span class="fc" id="L104">    return CallResult.success(jsonSerDes.readValue(response.body(), typeReference));</span>
  }

  /**
   * Create a new {@link com.github.badpop.jcoinbase.control.CallResult.Failure} containing the
   * error(s). Use only for coinbase protected data.
   *
   * @param response the http response
   * @param jsonSerDes the jackson object mapper to use
   * @param &lt;T&gt; the object type to deserialize
   * @return a new {@link CallResult} representing a failure
   * @throws JsonProcessingException if not deserializable
   */
  private static &lt;T&gt; CallResult&lt;Seq&lt;CoinbaseError&gt;, DataDto&lt;T&gt;&gt; buildFailure(
      final HttpResponse&lt;String&gt; response, final ObjectMapper jsonSerDes)
      throws JsonProcessingException {
<span class="fc" id="L120">    return CallResult.failure(</span>
        jsonSerDes
<span class="fc" id="L122">            .readValue(response.body(), new TypeReference&lt;DataErrorsDto&gt;() {})</span>
<span class="fc" id="L123">            .toCoinbaseErrors());</span>
  }

  /**
   * Create a new {@link com.github.badpop.jcoinbase.control.CallResult.Failure} containing a single
   * error. Only for coinbase public data.
   *
   * @param response the http response
   * @param jsonSerDes the jackson object mapper to use
   * @param &lt;T&gt; the object type to deserialize
   * @return a new {@link CallResult} representing a failure
   * @throws JsonProcessingException if not deserializable
   */
  private static &lt;T&gt; CallResult&lt;Seq&lt;CoinbaseError&gt;, DataDto&lt;T&gt;&gt; buildSingleFailure(
      final HttpResponse&lt;String&gt; response, final ObjectMapper jsonSerDes)
      throws JsonProcessingException {
<span class="fc" id="L139">    return CallResult.failure(</span>
<span class="fc" id="L140">        Seq(</span>
            jsonSerDes
<span class="fc" id="L142">                .readValue(response.body(), new TypeReference&lt;DataErrorDto&lt;SingleErrorDto&gt;&gt;() {})</span>
<span class="fc" id="L143">                .getError()</span>
<span class="fc" id="L144">                .toCoinbaseError()));</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>